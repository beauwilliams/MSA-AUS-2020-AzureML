{"version":3,"file":"reload.js","sourceRoot":"","sources":["../../../src/serve/reload.tsx"],"names":[],"mappings":"AAAA,OAAO,EAA+B,GAAG,EAAE,MAAM,gBAAgB,CAAC;AAClE,OAAO,EAAE,QAAQ,EAAE,EAAE,EAAE,MAAM,MAAM,CAAC;AACpC,OAAO,EAAE,IAAI,EAAE,MAAM,WAAW,CAAC;AACjC,OAAO,EAAE,SAAS,EAAE,GAAG,EAAE,UAAU,EAAE,MAAM,gBAAgB,CAAC;AAC5D,OAAO,EAAE,aAAa,EAAE,MAAM,yBAAyB,CAAC;AAExD,OAAO,EAAE,cAAc,EAAE,sBAAsB,EAAE,mBAAmB,EAAE,MAAM,UAAU,CAAC;AACvF,OAAO,EAAE,WAAW,EAAE,MAAM,uBAAuB,CAAC;AACpD,OAAO,EAAE,OAAO,EAAE,MAAM,4BAA4B,CAAC;AAGrD,MAAM,UAAU,KAAK,CAAsB,CAAM,EAAE,QAAgC;IACjF,MAAM,MAAM,GAAG,GAAG,EAAe,CAAC;IAClC,IAAI,CAAC,KAAK,CAAC;QACT,IAAI;YACF,UAAU,CAAC,GAAG,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,CAAC,SAAS,GAAG,EAAE,EAAE,EAAE,CAAC,CAAC;QACtD,CAAC;KACF,CAAC,CAAC;IAEH,OAAO,yBAAK,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE;;;;;;;;;;;;GAYhC;QACA,gBAAC,OAAO,OAAE;2CACL,CAAC;AACT,CAAC;AAGD,MAAM,UAAU,cAAc;IAC5B,IAAI,QAAQ,GAAG,KAAK,CAAC;IACrB,MAAM,QAAQ,GAAG,WAAW,EAAE,CAAC;IAE/B,MAAM,YAAY,GAAG,GAAG,EAAE;QACxB,IAAI,CAAC,QAAQ,EAAE;YACb,QAAQ,GAAG,IAAI,CAAC;YAChB,QAAQ,CAAC,MAAM,CAAC,gBAAC,KAAK,OAAE,CAAC,CAAC,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;SAC7C;IACH,CAAC,CAAA;IAED,QAAQ,CAAC,GAAG,CAAC,CAAC,IAAI,CAChB,SAAS,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC;QACjB,GAAG,EAAE,cAAc;QACnB,YAAY,EAAE,MAAM;QACpB,OAAO,EAAE,GAAG;KACb,CAAC;SACD,IAAI,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC,EAAE,CAAC,YAAY,EAAE,CAAC,CAAC,CAAC,CAC5C,EACD,GAAG,CAAC,MAAM,CAAC,EAAE;QACX,IAAI,MAAM,EAAE;YACV,IAAI,MAAM,CAAC,QAAQ,KAAK,sBAAsB;gBAAE,YAAY,EAAE,CAAC;iBAC1D,IAAI,MAAM,CAAC,QAAQ,KAAK,mBAAmB,IAAI,QAAQ,EAAE;gBAC5D,QAAQ,CAAC,MAAM,EAAE,CAAC;aACnB;SACF;IACH,CAAC,CAAC,CACH;SACA,SAAS,EAAE,CAAC;AACf,CAAC;AAGD,MAAM,CAAC,MAAM,eAAe,GAAG,aAAa,CAAA,aAAa,CAAC,cAAc,CAAC,CAAC","sourcesContent":["import { RendererLike, ComponentThis, ref } from '@connectv/html';\nimport { interval, of } from 'rxjs';\nimport { ajax } from 'rxjs/ajax';\nimport { switchMap, tap, catchError } from 'rxjs/operators';\nimport { funcTransport } from '@connectv/sdh/transport';\n\nimport { StatusCheckURL, StatusBuildingResponse, StatusReadyResponse } from './config';\nimport { getRenderer } from '../transport/renderer';\nimport { Loading } from '../components/util/loading';\n\n\nexport function Toast(this: ComponentThis, _: any, renderer: RendererLike<any, any>) {\n  const holder = ref<HTMLElement>();\n  this.track({\n    bind() {\n      setTimeout(() => holder.$.style.transform = '', 10);\n    }\n  });\n\n  return <div _ref={holder} style={`\n    position: fixed;\n    bottom: 32px; right: 32px;\n    z-index: 10000;\n    background: rgba(64, 64, 64, .65);\n    color: white;\n    padding: 24px;\n    border-radius: 8px;\n    transform: translateY(200px);\n    backdrop-filter: blur(12px);\n    -webkit-backdrop-filter: blur(12px);\n    transition: transform .3s;\n  `}>\n   <Loading/>  &ensp;Rebuilding documents ...\n  </div>;\n}\n\n\nexport function reloadOnChange() {\n  let building = false;\n  const renderer = getRenderer();\n\n  const buildingMode = () => {\n    if (!building) {\n      building = true;\n      renderer.render(<Toast/>).on(document.body);\n    }\n  }\n\n  interval(500).pipe(\n    switchMap(() => ajax({\n        url: StatusCheckURL,\n        responseType: 'text',\n        timeout: 200,\n      })\n      .pipe(catchError(() => of(buildingMode())))\n    ),\n    tap(result => {\n      if (result) {\n        if (result.response === StatusBuildingResponse) buildingMode();\n        else if (result.response === StatusReadyResponse && building) {\n          location.reload();\n        }\n      }\n    }),\n  )\n  .subscribe();\n}\n\n\nexport const reloadOnChange$ = /*#__PURE__*/funcTransport(reloadOnChange);\n"]}